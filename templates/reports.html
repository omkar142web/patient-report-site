<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
  </head>
  <body>
    <div class="layout">
      <div class="sidebar">
        <a href="{{ url_for('reports') }}" class="clinic-logo">ðŸ©º Clinic</a>
        <a href="{{ url_for('logout') }}" class="logout">Logout</a>
      </div>

      <div class="main">
        <h1>Patient Records</h1>

        <form class="search-box" action="{{ url_for('reports') }}" method="get">
          <label for="search" class="sr-only"
            >Search patient or report name</label
          >
          <input
            id="search"
            name="search"
            placeholder="ðŸ” Search patient or report name..."
            value="{{ search }}"
          />
          <button type="submit" class="search-btn">Search</button>
        </form>

        {% if not data %}
        <div class="no-data">
          <p>No patients found.</p>
        </div>
        {% endif %} {% for patient, patient_data in data.items() %}

        <section class="patient-section">
          <button class="patient-toggle" onclick="togglePatient('{{ loop.index }}')">
  <span>ðŸ‘¤ {{ patient }}</span>

  <div class="patient-info-wrapper" onclick="event.stopPropagation()">
    <span class="info-icon">â“˜</span>

    <div class="patient-info-card">
      <div class="patient-header">ðŸ‘¤ {{ patient }}</div>

      <div class="patient-stats">
        ðŸ“„ PDFs: {{ patient_data.pdf_count }} |
        ðŸ–¼ Images: {{ patient_data.image_count }} |
        ðŸŽž Videos: {{ patient_data.video_count }}
      </div>

      <!-- <form method="POST" action="{{ url_for('download_zip') }}">
        <input type="hidden" name="patient" value="{{ patient }}" />

        <label><input type="checkbox" name="types" value="pdf" checked /> PDFs</label><br />
        <label><input type="checkbox" name="types" value="image" checked /> Images</label><br />
        <label><input type="checkbox" name="types" value="video" checked /> Videos</label><br />

        <button type="submit" class="zip-btn">ðŸ“Ž Download ZIP</button>
      </form> -->
    </div>
  </div>
</button>


          <div class="patient-files" id="patient-{{ loop.index }}">
            <div class="grid">
              {% for file_obj in patient_data.files %}

              <div class="card">
                <div class="file-name">{{ file_obj.name }}</div>
                <div class="file-date">Uploaded on: {{ file_obj.date }}</div>

                {% if file_obj.is_pdf %}
                <span class="badge pdf">PDF</span>
                <!-- Link to the full PDF -->
                <a href="{{ file_obj.url }}" target="_blank" rel="noopener noreferrer">
                  <!-- Show the generated thumbnail image -->
                  <img 
                    src="{{ file_obj.thumbnail_url }}" 
                    alt="Preview of PDF: {{ file_obj.name }}"
                  />
                </a>
                {% elif file_obj.is_video %}
                <span class="badge video">VIDEO</span>
                <video
                  src="{{ file_obj.url }}"
                  controls
                  preload="metadata"
                ></video>
                {% else %}
                <span class="badge img">IMG</span>
                <img
                  src="{{ file_obj.url }}"
                  alt="Image preview for {{ file_obj.name }}"
                />
                {% endif %}

                <div class="actions">
                  <a
                    href="{{ file_obj.url }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    >Open</a
                  >
                  <form
                    action="{{ url_for('delete_file') }}"
                    method="post"
                    style="display: inline"
                  >
                    <input
                      type="hidden"
                      name="public_id"
                      value="{{ file_obj.public_id }}"
                    />
                    <input
                      type="hidden"
                      name="resource_type"
                      value="{{ file_obj.resource_type }}"
                    />
                    <button type="submit" class="delete">Delete</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </section>
        {% endfor %}
      </div>
    </div>

    <script>
      function togglePatient(id) {
        const el = document.getElementById("patient-" + id);
        const btn = el.previousElementSibling; // The button
        if (el.style.display === "none" || el.style.display === "") {
          el.style.display = "block";
          btn.classList.add("active");
        } else {
          el.style.display = "none";
          btn.classList.remove("active");
        }
      }
    </script>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <script>
      showToast("{{ message }}", "{{ category }}");
    </script>
    {% endfor %} {% endif %} {% endwith %}

    <script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".info-icon").forEach(icon => {
    icon.addEventListener("click", e => {
      e.stopPropagation();
      const wrapper = icon.closest(".patient-info-wrapper");
      wrapper.classList.toggle("open");
    });
  });

  document.addEventListener("click", () => {
    document
      .querySelectorAll(".patient-info-wrapper.open")
      .forEach(el => el.classList.remove("open"));
  });
});
</script>


  </body>
</html>
